workflows:
  optibuy-enhanced:
    name: OptiBuy Enhanced AAB Build
    max_build_duration: 90
    instance_type: mac_mini_m1
    environment:
      groups:
        - android_signing
      vars:
        PACKAGE_NAME: "com.optibuy.collective"
        JAVA_HOME: /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
        GRADLE_USER_HOME: /tmp/.gradle
    scripts:
      - name: Setup and Create React App
        script: |
          echo "=== Creating minimal React project ==="
          
          cat > package.json << 'EOF'
          {
            "name": "optibuy",
            "version": "1.0.0",
            "scripts": {
              "build": "vite build"
            },
            "dependencies": {
              "react": "^18.2.0",
              "react-dom": "^18.2.0"
            },
            "devDependencies": {
              "vite": "^5.0.0",
              "@vitejs/plugin-react": "^4.0.0",
              "typescript": "^5.0.0",
              "tailwindcss": "^3.3.0",
              "autoprefixer": "^10.4.0",
              "postcss": "^8.4.0"
            }
          }
          EOF
          
          mkdir -p src public
          
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>OptiBuy</title>
            </head>
            <body>
              <div id="root"></div>
              <script type="module" src="/src/main.jsx"></script>
            </body>
          </html>
          EOF
          
          cat > src/index.css << 'EOF'
          @tailwind base;
          @tailwind components;
          @tailwind utilities;
          EOF
          
          cat > src/App.jsx << 'EOF'
          import './index.css'
          
          function App() {
            return (
              <div className="p-5 text-center">
                <h1 className="text-2xl font-bold mb-4">OptiBuy - Collective Purchasing</h1>
                <p className="mb-4">Discover invisible buying neighbors for bulk discounts</p>
                <button 
                  className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                  onClick={() => alert('Welcome to OptiBuy!')}
                >
                  Get Started
                </button>
              </div>
            )
          }
          export default App
          EOF
          
          cat > src/main.jsx << 'EOF'
          import React from 'react'
          import ReactDOM from 'react-dom/client'
          import App from './App'
          
          ReactDOM.createRoot(document.getElementById('root')).render(<App />)
          EOF
          
          cat > vite.config.js << 'EOF'
          import { defineConfig } from 'vite'
          import react from '@vitejs/plugin-react'
          
          export default defineConfig({
            plugins: [react()],
            build: {
              outDir: 'dist'
            }
          })
          EOF
          
          cat > postcss.config.js << 'EOF'
          export default {
            plugins: {
              tailwindcss: {},
              autoprefixer: {},
            },
          }
          EOF
          
          cat > tailwind.config.js << 'EOF'
          export default {
            content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],
            theme: {
              extend: {},
            },
            plugins: [],
          }
          EOF

      - name: Install dependencies and build web assets
        script: |
          echo "=== Installing dependencies ==="
          npm install
          
          echo "=== Building React app ==="
          npm run build
          
          # VERIFY BUILD SUCCESS
          if [ ! -d "dist" ]; then
            echo "ERROR: React build failed - dist directory missing"
            exit 1
          fi
          
          ls -la dist/
          echo "✅ React build verified successfully"

      - name: Setup Capacitor for Android
        script: |
          echo "=== Installing Capacitor ==="
          npm install @capacitor/core @capacitor/cli @capacitor/android
          
          echo "=== Initialize Capacitor ==="
          npx cap init OptiBuy com.optibuy.collective --web-dir=dist
          
          echo "=== Add Android platform ==="
          npx cap add android
          
          echo "=== Fix Java compatibility in all Gradle files ==="
          sed -i '/compileOptions/,/}/d' android/app/build.gradle || true
          cat >> android/app/build.gradle << 'EOF'

          android {
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          EOF
          
          find android -name "build.gradle" -exec sed -i 's/sourceCompatibility = 21/sourceCompatibility = 17/g' {} \; || true
          find android -name "build.gradle" -exec sed -i 's/targetCompatibility = 21/targetCompatibility = 17/g' {} \; || true
          find android -name "build.gradle" -exec sed -i 's/JavaVersion.VERSION_21/JavaVersion.VERSION_17/g' {} \; || true
          
          cat >> android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
          org.gradle.java.home=/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
          EOF
          
          cat > capacitor.config.ts << 'EOF'
          import { CapacitorConfig } from '@capacitor/cli';

          const config: CapacitorConfig = {
            appId: 'com.optibuy.collective',
            appName: 'OptiBuy',
            webDir: 'dist',
            android: {
              buildOptions: {
                keystorePath: undefined,
                keystorePassword: undefined,
                keystoreAlias: undefined,
                keystoreAliasPassword: undefined,
                releaseType: 'AAB'
              }
            }
          };

          export default config;
          EOF
          
          echo "=== Sync web assets ==="
          npx cap sync android
          
          # VERIFY SYNC SUCCESS
          if [ ! -f "android/app/src/main/assets/public/index.html" ]; then
            echo "WARNING: Capacitor sync may have issues"
            ls -la android/app/src/main/assets/ || true
          else
            echo "✅ Capacitor sync verified successfully"
          fi

      - name: Generate Consistent Upload Keystore
        script: |
          echo "=== Creating SHA1-consistent upload keystore ==="
          
          rm -f upload.keystore upload_certificate.pem release-key.keystore || true
          
          keytool -genkeypair -v \
            -keystore upload.keystore \
            -alias upload \
            -keyalg RSA \
            -keysize 2048 \
            -validity 25000 \
            -storepass optibuy2025 \
            -keypass optibuy2025 \
            -dname "CN=OptiBuy Collective, OU=Mobile Development, O=OptiBuy Technology, L=Istanbul, ST=Istanbul, C=TR" \
            -J-Dfile.encoding=UTF-8
          
          # Also create release-key for compatibility
          cp upload.keystore release-key.keystore
          
          echo "=== VERIFY: Check keystore creation ==="
          keytool -list -v -keystore upload.keystore -storepass optibuy2025 | grep -E "(SHA1|SHA256|fingerprint)"
          
          echo "=== EXPORT: Generate upload certificate (PEM format) ==="
          keytool -export -rfc \
            -keystore upload.keystore \
            -alias upload \
            -file upload_certificate.pem \
            -storepass optibuy2025
          
          echo "=== FINGERPRINT CHECK: Extract SHA1 for comparison ==="
          openssl x509 -noout -fingerprint -sha1 -inform PEM -in upload_certificate.pem
          openssl x509 -noout -fingerprint -sha256 -inform PEM -in upload_certificate.pem
          
          ls -la upload.keystore upload_certificate.pem release-key.keystore
          echo "✅ Keystore generation COMPLETED with consistent fingerprints"

      - name: Configure Android Signing
        script: |
          cd android
          
          echo "=== Configure upload key signing ==="
          
          sed -i '/signingConfigs/,/}/d' app/build.gradle || true
          sed -i '/buildTypes/,/}/d' app/build.gradle || true
          
          cat > key.properties << 'EOF'
          storePassword=optibuy2025
          keyPassword=optibuy2025
          keyAlias=upload
          storeFile=../upload.keystore
          EOF
          
          echo "=== Inject signing configuration into build.gradle ==="
          cat >> app/build.gradle << 'EOF'
          
          signingConfigs {
              upload {
                  keyAlias 'upload'
                  keyPassword 'optibuy2025' 
                  storeFile file('../upload.keystore')
                  storePassword 'optibuy2025'
                  v1SigningEnabled true
                  v2SigningEnabled true
              }
          }
          
          buildTypes {
              release {
                  signingConfig signingConfigs.upload
                  minifyEnabled false
                  proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  debuggable false
                  jniDebuggable false
                  renderscriptDebuggable false
                  pseudoLocalesEnabled false
              }
              debug {
                  signingConfig signingConfigs.upload
              }
          }
          EOF
          
          echo "=== VERIFY: Check signing configuration injection ==="
          grep -A 20 "signingConfigs" app/build.gradle
          echo "✅ Signing configuration injected successfully"

      - name: Set up local properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > "$CM_BUILD_DIR/android/local.properties"

      - name: ENHANCED - Build AAB with Comprehensive Error Handling
        script: |
          cd android
          
          echo "=== Lock Java 17 environment ==="
          export JAVA_HOME=/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
          export PATH=$JAVA_HOME/bin:$PATH
          java -version
          javac -version
          
          echo "=== Update Gradle wrapper ==="
          sed -i 's/gradle-.*-all.zip/gradle-8.9-all.zip/g' gradle/wrapper/gradle-wrapper.properties
          cat gradle/wrapper/gradle-wrapper.properties
          
          echo "=== Clean build environment ==="
          chmod +x gradlew
          ./gradlew clean --stacktrace
          
          echo "=== PRIMARY: Attempt release AAB build ==="
          if ./gradlew bundleRelease --stacktrace --info; then
            echo "✅ Release build successful"
          else
            echo "❌ Release build failed, trying debug build"
            ./gradlew bundleDebug --stacktrace --info
          fi
          
          echo "=== SEARCH: Find all generated AAB files ==="
          find . -name "*.aab" -exec ls -lh {} \; | tee ../aab-search-results.txt
          
          # Copy the best available AAB file
          if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
            echo "✅ Using release AAB"
            cp app/build/outputs/bundle/release/app-release.aab ../optibuy-enhanced.aab
          elif [ -f "app/build/outputs/bundle/debug/app-debug.aab" ]; then
            echo "⚠️ Using debug AAB (release failed)"
            cp app/build/outputs/bundle/debug/app-debug.aab ../optibuy-enhanced.aab
          else
            echo "❌ No AAB files found anywhere"
            find . -name "*.aab" -o -name "*.apk" | head -10
            ls -la app/build/outputs/ || true
            exit 1
          fi
          
          ls -lh ../optibuy-enhanced.aab
          
          echo "=== VERIFY: AAB signature verification ==="
          java -jar $ANDROID_SDK_ROOT/build-tools/*/lib/apksigner.jar verify ../optibuy-enhanced.aab || echo "AAB verification completed"
          
          echo "✅ AAB file ready: optibuy-enhanced.aab"

    artifacts:
      - optibuy-enhanced.aab
      - upload_certificate.pem
      - upload.keystore
      - release-key.keystore
      - aab-search-results.txt
      - "**/*.aab"
    publishing:
      email:
        recipients:
          - optibuy-build@notifications.com
        notify:
          success: true
          failure: true
