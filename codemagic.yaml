workflows:
  optibuy:
    name: OptiBuy - Permanent Keystore Build
    max_build_duration: 90
    instance_type: mac_mini_m1
    environment:
      vars:
        PACKAGE_NAME: "com.optibuy.collective"
        ANDROID_SDK_ROOT: /usr/local/share/android-sdk
        ANDROID_HOME: /usr/local/share/android-sdk
        JAVA_HOME: /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
        KEYSTORE_PASSWORD: "OptiBuy2025Fresh"
        KEY_ALIAS: "upload"
        KEY_PASSWORD: "OptiBuy2025Fresh"
    scripts:
      - name: Create Minimal Android Project
        script: |
          echo "=== Creating Minimal Android Project ==="
          
          mkdir -p OptiBuy/android/app/src/main/java/com/optibuy/collective
          mkdir -p OptiBuy/android/app/src/main/res/values
          mkdir -p OptiBuy/android/app/src/main/res/layout
          mkdir -p OptiBuy/android/app/src/main/res/mipmap-hdpi
          mkdir -p OptiBuy/android/app/src/main/res/mipmap-mdpi
          mkdir -p OptiBuy/android/app/src/main/res/mipmap-xhdpi
          mkdir -p OptiBuy/android/app/src/main/res/mipmap-xxhdpi
          mkdir -p OptiBuy/android/app/src/main/res/mipmap-xxxhdpi
          mkdir -p OptiBuy/android/gradle/wrapper
          
          cd OptiBuy
          
          echo "Creating gradle wrapper properties..."
          cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.1.1-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          
          echo "Creating gradle.properties..."
          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          android.bundle.enableUncompressedNativeLibs=false
          android.enableR8.fullMode=true
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.daemon=true
          EOF
          
          echo "Creating settings.gradle..."
          cat > android/settings.gradle << 'EOF'
          rootProject.name = 'OptiBuy'
          include ':app'
          project(':app').projectDir = new File(rootProject.projectDir, 'app')
          EOF
          
          echo "Creating root build.gradle..."
          cat > android/build.gradle << 'EOF'
          buildscript {
              ext {
                  buildToolsVersion = "34.0.0"
                  minSdkVersion = 21
                  compileSdkVersion = 35
                  targetSdkVersion = 35
              }
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.1.4'
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF
          
          echo "Creating app build.gradle..."
          cat > android/app/build.gradle << 'EOF'
          apply plugin: 'com.android.application'
          
          android {
              namespace 'com.optibuy.collective'
              compileSdkVersion rootProject.ext.compileSdkVersion
              buildToolsVersion rootProject.ext.buildToolsVersion
              
              defaultConfig {
                  applicationId "com.optibuy.collective"
                  minSdkVersion rootProject.ext.minSdkVersion
                  targetSdkVersion rootProject.ext.targetSdkVersion
                  versionCode 15
                  versionName "2.5.0"
              }
              
              signingConfigs {
                  release {
                      storeFile file('optibuy-permanent-upload.jks')
                      storePassword System.getenv("KEYSTORE_PASSWORD") ?: "OptiBuy2025Fresh"
                      keyAlias System.getenv("KEY_ALIAS") ?: "upload"
                      keyPassword System.getenv("KEY_PASSWORD") ?: "OptiBuy2025Fresh"
                  }
              }
              
              buildTypes {
                  release {
                      minifyEnabled true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                      signingConfig signingConfigs.release
                  }
              }
              
              bundle {
                  language {
                      enableSplit = false
                  }
                  density {
                      enableSplit = true
                  }
                  abi {
                      enableSplit = true
                  }
              }
          }
          
          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
              implementation 'com.google.android.material:material:1.9.0'
              implementation 'androidx.webkit:webkit:1.8.0'
          }
          EOF
          
          echo "Creating AndroidManifest.xml..."
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              
              <!-- Support all screen sizes including tablets -->
              <supports-screens
                  android:smallScreens="true"
                  android:normalScreens="true"
                  android:largeScreens="true"
                  android:xlargeScreens="true"
                  android:anyDensity="true" />
              
              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:label="@string/app_name"
                  android:theme="@style/AppTheme"
                  android:hardwareAccelerated="true"
                  android:usesCleartextTraffic="false">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:configChanges="orientation|screenSize|keyboardHidden|keyboard|navigation"
                      android:screenOrientation="unspecified">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          echo "Project structure created successfully"
          
      - name: Create Permanent Keystore from Base64
        script: |
          echo "=== Creating Permanent Keystore ==="
          cd OptiBuy
          
          # Decode the NEW permanent keystore from base64
          echo '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' | base64 -d > android/app/optibuy-permanent-upload.jks
          
          echo "Keystore created. Verifying fingerprint..."
          keytool -list -v -keystore android/app/optibuy-permanent-upload.jks -storepass OptiBuy2025Fresh -alias upload | grep "SHA1"
          
          # Export PEM certificate for Google Play
          keytool -export -rfc -alias upload -file optibuy-upload-certificate.pem -keystore android/app/optibuy-permanent-upload.jks -storepass OptiBuy2025Fresh
          echo "PEM certificate exported for Google Play Console upload"
          
      - name: Create Android Resources and Code
        script: |
          echo "=== Creating Android Resources and Code ==="
          cd OptiBuy
          
          echo "Creating strings.xml..."
          cat > android/app/src/main/res/values/strings.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">OptiBuy</string>
              <string name="welcome_title">OptiBuy</string>
              <string name="welcome_subtitle">Collective Purchasing Platform</string>
              <string name="welcome_description">Ready for Google Play Store deployment</string>
          </resources>
          EOF
          
          echo "Creating styles.xml..."
          cat > android/app/src/main/res/values/styles.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <style name="AppTheme" parent="Theme.AppCompat.Light.NoActionBar">
                  <item name="colorPrimary">#4285F4</item>
                  <item name="colorPrimaryDark">#3367D6</item>
                  <item name="colorAccent">#34A853</item>
                  <item name="android:windowFullscreen">true</item>
                  <item name="android:windowNoTitle">true</item>
              </style>
          </resources>
          EOF
          
          echo "Creating activity_main.xml layout WITHOUT WebView (will be added programmatically)..."
          cat > android/app/src/main/res/layout/activity_main.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:id="@+id/rootContainer"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:background="#FFFFFF">
          
              <LinearLayout
                  android:id="@+id/loadingContainer"
                  android:layout_width="match_parent"
                  android:layout_height="match_parent"
                  android:orientation="vertical"
                  android:gravity="center"
                  android:padding="30dp">
                  
                  <ImageView
                      android:id="@+id/appLogo"
                      android:layout_width="120dp"
                      android:layout_height="120dp"
                      android:src="@mipmap/ic_launcher"
                      android:layout_marginBottom="30dp" />
                  
                  <ProgressBar
                      android:id="@+id/progressBar"
                      style="?android:attr/progressBarStyle"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content" />
                  
                  <TextView
                      android:id="@+id/statusText"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:layout_marginTop="20dp"
                      android:text="Loading OptiBuy..."
                      android:textColor="#333333"
                      android:textSize="16sp" />
                  
                  <TextView
                      android:id="@+id/errorText"
                      android:layout_width="match_parent"
                      android:layout_height="wrap_content"
                      android:layout_marginTop="20dp"
                      android:textColor="#CC0000"
                      android:textSize="14sp"
                      android:visibility="gone"
                      android:gravity="center"
                      android:lineSpacingMultiplier="1.3" />
                      
                  <Button
                      android:id="@+id/retryButton"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:layout_marginTop="20dp"
                      android:text="Retry"
                      android:visibility="gone"
                      android:paddingHorizontal="30dp" />
              </LinearLayout>
          
          </FrameLayout>
          EOF
          
          echo "Creating MainActivity.java with SAFE WebView initialization..."
          cat > android/app/src/main/java/com/optibuy/collective/MainActivity.java << 'EOF'
          package com.optibuy.collective;
          
          import androidx.appcompat.app.AppCompatActivity;
          import androidx.webkit.WebViewCompat;
          import android.content.Intent;
          import android.content.pm.ApplicationInfo;
          import android.content.pm.PackageInfo;
          import android.content.pm.PackageManager;
          import android.net.Uri;
          import android.net.http.SslError;
          import android.os.Bundle;
          import android.os.Handler;
          import android.os.Looper;
          import android.util.Log;
          import android.view.KeyEvent;
          import android.view.View;
          import android.view.ViewGroup;
          import android.webkit.SslErrorHandler;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import android.webkit.WebChromeClient;
          import android.webkit.WebSettings;
          import android.webkit.WebResourceError;
          import android.webkit.WebResourceRequest;
          import android.widget.Button;
          import android.widget.FrameLayout;
          import android.widget.LinearLayout;
          import android.widget.ProgressBar;
          import android.widget.TextView;
          import android.graphics.Color;
          
          public class MainActivity extends AppCompatActivity {
              private static final String TAG = "OptiBuy";
              private WebView webView;
              private FrameLayout rootContainer;
              private LinearLayout loadingContainer;
              private ProgressBar progressBar;
              private TextView statusText;
              private TextView errorText;
              private Button retryButton;
              private static final String APP_URL = "https://opti-buy-tracker-metealper.replit.app";
              
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  
                  try {
                      setContentView(R.layout.activity_main);
                      
                      rootContainer = findViewById(R.id.rootContainer);
                      loadingContainer = findViewById(R.id.loadingContainer);
                      progressBar = findViewById(R.id.progressBar);
                      statusText = findViewById(R.id.statusText);
                      errorText = findViewById(R.id.errorText);
                      retryButton = findViewById(R.id.retryButton);
                      
                      retryButton.setOnClickListener(new View.OnClickListener() {
                          @Override
                          public void onClick(View v) {
                              hideError();
                              initializeWebView();
                          }
                      });
                      
                      if (!isWebViewAvailable()) {
                          showWebViewMissingError();
                          return;
                      }
                      
                      new Handler(Looper.getMainLooper()).postDelayed(new Runnable() {
                          @Override
                          public void run() {
                              initializeWebView();
                          }
                      }, 100);
                      
                  } catch (Exception e) {
                      Log.e(TAG, "Error in onCreate: " + e.getMessage(), e);
                      showError("App initialization failed.\n\nPlease ensure Android System WebView or Chrome is enabled in your device settings.");
                  }
              }
              
              private boolean isWebViewAvailable() {
                  try {
                      PackageInfo webViewPackage = WebViewCompat.getCurrentWebViewPackage(this);
                      if (webViewPackage == null) {
                          Log.e(TAG, "No WebView package found");
                          return false;
                      }
                      
                      String packageName = webViewPackage.packageName;
                      Log.d(TAG, "WebView package found: " + packageName + " v" + webViewPackage.versionName);
                      
                      PackageManager pm = getPackageManager();
                      ApplicationInfo appInfo = pm.getApplicationInfo(packageName, 0);
                      boolean isEnabled = appInfo.enabled;
                      Log.d(TAG, "WebView package enabled: " + isEnabled);
                      
                      if (!isEnabled) {
                          Log.e(TAG, "WebView package is DISABLED");
                          return false;
                      }
                      
                      return true;
                  } catch (PackageManager.NameNotFoundException e) {
                      Log.e(TAG, "WebView package not found: " + e.getMessage());
                      return false;
                  } catch (Exception e) {
                      Log.e(TAG, "WebView check failed: " + e.getMessage());
                      return false;
                  }
              }
              
              private void showWebViewMissingError() {
                  String errorMessage = "WebView is not available on this device.\n\n" +
                      "To fix this:\n" +
                      "1. Open Google Play Store\n" +
                      "2. Search for 'Android System WebView'\n" +
                      "3. Update or Enable it\n\n" +
                      "Or enable Chrome browser in Settings > Apps";
                  showError(errorMessage);
                  
                  retryButton.setText("Open Play Store");
                  retryButton.setOnClickListener(new View.OnClickListener() {
                      @Override
                      public void onClick(View v) {
                          try {
                              Intent intent = new Intent(Intent.ACTION_VIEW);
                              intent.setData(Uri.parse("market://details?id=com.google.android.webview"));
                              startActivity(intent);
                          } catch (Exception e) {
                              Intent intent = new Intent(Intent.ACTION_VIEW);
                              intent.setData(Uri.parse("https://play.google.com/store/apps/details?id=com.google.android.webview"));
                              startActivity(intent);
                          }
                      }
                  });
              }
              
              private void initializeWebView() {
                  try {
                      Log.d(TAG, "Creating WebView programmatically...");
                      
                      webView = new WebView(this);
                      webView.setLayoutParams(new FrameLayout.LayoutParams(
                          ViewGroup.LayoutParams.MATCH_PARENT,
                          ViewGroup.LayoutParams.MATCH_PARENT
                      ));
                      webView.setBackgroundColor(Color.WHITE);
                      webView.setVisibility(View.GONE);
                      
                      rootContainer.addView(webView, 0);
                      
                      WebSettings settings = webView.getSettings();
                      settings.setJavaScriptEnabled(true);
                      settings.setDomStorageEnabled(true);
                      settings.setDatabaseEnabled(true);
                      settings.setCacheMode(WebSettings.LOAD_NO_CACHE);
                      settings.setAllowFileAccess(false);
                      settings.setAllowContentAccess(false);
                      settings.setLoadsImagesAutomatically(true);
                      settings.setMixedContentMode(WebSettings.MIXED_CONTENT_NEVER_ALLOW);
                      settings.setSupportZoom(false);
                      settings.setBuiltInZoomControls(false);
                      settings.setDisplayZoomControls(false);
                      settings.setUseWideViewPort(true);
                      settings.setLoadWithOverviewMode(true);
                      settings.setMediaPlaybackRequiresUserGesture(false);
                      
                      webView.setWebViewClient(new WebViewClient() {
                          @Override
                          public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
                              String url = request.getUrl().toString();
                              if (url.startsWith("https://opti-buy-tracker-metealper.replit.app")) {
                                  return false;
                              }
                              Intent intent = new Intent(Intent.ACTION_VIEW, request.getUrl());
                              startActivity(intent);
                              return true;
                          }
                          
                          @Override
                          public void onPageFinished(WebView view, String url) {
                              super.onPageFinished(view, url);
                              loadingContainer.setVisibility(View.GONE);
                              webView.setVisibility(View.VISIBLE);
                              Log.d(TAG, "Page loaded: " + url);
                          }
                          
                          @Override
                          public void onReceivedError(WebView view, WebResourceRequest request, WebResourceError error) {
                              super.onReceivedError(view, request, error);
                              if (request.isForMainFrame()) {
                                  Log.e(TAG, "WebView error: " + error.getDescription());
                                  showError("Connection error.\n\nPlease check your internet connection and try again.");
                              }
                          }
                          
                          @Override
                          public void onReceivedSslError(WebView view, SslErrorHandler handler, SslError error) {
                              Log.e(TAG, "SSL error: " + error.toString());
                              handler.cancel();
                              showError("Secure connection failed.\n\nPlease check your internet connection and try again.");
                          }
                      });
                      
                      webView.setWebChromeClient(new WebChromeClient());
                      
                      Log.d(TAG, "Loading URL: " + APP_URL);
                      statusText.setText("Connecting to OptiBuy...");
                      webView.loadUrl(APP_URL);
                      
                  } catch (Exception e) {
                      Log.e(TAG, "WebView initialization failed: " + e.getMessage(), e);
                      showError("Failed to load app.\n\nPlease update Android System WebView from Play Store and try again.");
                  }
              }
              
              private void showError(String message) {
                  if (progressBar != null) progressBar.setVisibility(View.GONE);
                  if (statusText != null) statusText.setVisibility(View.GONE);
                  if (errorText != null) {
                      errorText.setText(message);
                      errorText.setVisibility(View.VISIBLE);
                  }
                  if (retryButton != null) retryButton.setVisibility(View.VISIBLE);
                  if (webView != null) webView.setVisibility(View.GONE);
                  if (loadingContainer != null) loadingContainer.setVisibility(View.VISIBLE);
              }
              
              private void hideError() {
                  if (progressBar != null) progressBar.setVisibility(View.VISIBLE);
                  if (statusText != null) {
                      statusText.setText("Loading OptiBuy...");
                      statusText.setVisibility(View.VISIBLE);
                  }
                  if (errorText != null) errorText.setVisibility(View.GONE);
                  if (retryButton != null) retryButton.setVisibility(View.GONE);
              }
              
              @Override
              public boolean onKeyDown(int keyCode, KeyEvent event) {
                  if (keyCode == KeyEvent.KEYCODE_BACK && webView != null && webView.canGoBack()) {
                      webView.goBack();
                      return true;
                  }
                  return super.onKeyDown(keyCode, event);
              }
              
              @Override
              protected void onResume() {
                  super.onResume();
                  if (webView != null) webView.onResume();
              }
              
              @Override
              protected void onPause() {
                  if (webView != null) webView.onPause();
                  super.onPause();
              }
              
              @Override
              protected void onDestroy() {
                  if (webView != null) {
                      webView.destroy();
                  }
                  super.onDestroy();
              }
          }
          EOF
          
          echo "Creating proguard-rules.pro..."
          cat > android/app/proguard-rules.pro << 'EOF'
          # Add project specific ProGuard rules here.
          -keep class com.optibuy.collective.** { *; }
          -keep class android.webkit.** { *; }
          -dontwarn okio.**
          -dontwarn retrofit2.**
          -keepattributes JavascriptInterface
          EOF
          
          echo "Downloading and creating app icons..."
          # Download the actual OptiBuy logo from the deployed app
          curl -L -o icon_original.png "https://opti-buy-tracker-metealper.replit.app/app-icon.png"
          
          # Verify download
          if [ -f "icon_original.png" ]; then
            echo "Icon downloaded successfully"
            file icon_original.png
            
            # Get original dimensions
            ORIG_SIZE=$(sips -g pixelWidth icon_original.png | tail -1 | awk '{print $2}')
            echo "Original icon size: ${ORIG_SIZE}x${ORIG_SIZE}"
            
            # First upscale to 1024x1024 if smaller (for better quality when scaling down)
            if [ "$ORIG_SIZE" -lt 1024 ]; then
              echo "Upscaling from ${ORIG_SIZE} to 1024 for better quality..."
              sips -z 1024 1024 icon_original.png --out icon_1024.png
            else
              cp icon_original.png icon_1024.png
            fi
            
            # Create adaptive icon directories
            mkdir -p android/app/src/main/res/mipmap-anydpi-v26
            mkdir -p android/app/src/main/res/drawable
            
            # Resize to all Android mipmap sizes using sips (macOS)
            sips -z 48 48 icon_1024.png --out android/app/src/main/res/mipmap-mdpi/ic_launcher.png
            sips -z 72 72 icon_1024.png --out android/app/src/main/res/mipmap-hdpi/ic_launcher.png
            sips -z 96 96 icon_1024.png --out android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
            sips -z 144 144 icon_1024.png --out android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
            sips -z 192 192 icon_1024.png --out android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
            
            # Foreground icons for adaptive icons
            sips -z 108 108 icon_1024.png --out android/app/src/main/res/mipmap-mdpi/ic_launcher_foreground.png
            sips -z 162 162 icon_1024.png --out android/app/src/main/res/mipmap-hdpi/ic_launcher_foreground.png
            sips -z 216 216 icon_1024.png --out android/app/src/main/res/mipmap-xhdpi/ic_launcher_foreground.png
            sips -z 324 324 icon_1024.png --out android/app/src/main/res/mipmap-xxhdpi/ic_launcher_foreground.png
            sips -z 432 432 icon_1024.png --out android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_foreground.png
            
            # Create round icons (same as regular)
            cp android/app/src/main/res/mipmap-mdpi/ic_launcher.png android/app/src/main/res/mipmap-mdpi/ic_launcher_round.png
            cp android/app/src/main/res/mipmap-hdpi/ic_launcher.png android/app/src/main/res/mipmap-hdpi/ic_launcher_round.png
            cp android/app/src/main/res/mipmap-xhdpi/ic_launcher.png android/app/src/main/res/mipmap-xhdpi/ic_launcher_round.png
            cp android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png
            cp android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
            
            # Create adaptive icon background color
            echo '<?xml version="1.0" encoding="utf-8"?>' > android/app/src/main/res/drawable/ic_launcher_background.xml
            echo '<shape xmlns:android="http://schemas.android.com/apk/res/android">' >> android/app/src/main/res/drawable/ic_launcher_background.xml
            echo '    <solid android:color="#FFFFFF"/>' >> android/app/src/main/res/drawable/ic_launcher_background.xml
            echo '</shape>' >> android/app/src/main/res/drawable/ic_launcher_background.xml
            
            # Create adaptive icon XML for Android 8+ (API 26+)
            echo '<?xml version="1.0" encoding="utf-8"?>' > android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
            echo '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' >> android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
            echo '    <background android:drawable="@drawable/ic_launcher_background"/>' >> android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
            echo '    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>' >> android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
            echo '</adaptive-icon>' >> android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
            
            echo '<?xml version="1.0" encoding="utf-8"?>' > android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml
            echo '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' >> android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml
            echo '    <background android:drawable="@drawable/ic_launcher_background"/>' >> android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml
            echo '    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>' >> android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml
            echo '</adaptive-icon>' >> android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml
            
            echo "App icons created at all densities with adaptive icon support"
            ls -la android/app/src/main/res/mipmap-*/ic_launcher*.png
            ls -la android/app/src/main/res/mipmap-anydpi-v26/
          else
            echo "ERROR: Failed to download icon"
            exit 1
          fi
          
          echo "Android resources and code created successfully"
          
      - name: Build AAB with System Gradle
        script: |
          echo "=== Building AAB for Google Play Console ==="
          cd OptiBuy/android
          
          echo "Using system gradle directly..."
          which gradle
          gradle --version
          
          echo "Running gradle clean..."
          gradle clean
          
          echo "Building AAB bundle..."
          gradle bundleRelease
          
          echo "=== AAB Build Verification ==="
          find . -name "*.aab" -type f
          ls -la app/build/outputs/bundle/release/ || echo "Release directory not found"
          
          if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
              echo "AAB file created successfully"
              file app/build/outputs/bundle/release/app-release.aab
              
              cd ../..
              cp OptiBuy/android/app/build/outputs/bundle/release/app-release.aab ./optibuy-google-play-ready.aab
              cp OptiBuy/android/app/build/outputs/bundle/release/app-release.aab ./optibuy-$(date +%Y%m%d-%H%M).aab
              
              echo "=== GOOGLE PLAY CONSOLE UPLOAD READY ===" > google_play_deployment.txt
              echo "Package: com.optibuy.collective" >> google_play_deployment.txt
              echo "Version Code: 15" >> google_play_deployment.txt
              echo "Version Name: 2.5.0" >> google_play_deployment.txt
              echo "Target SDK: 35 (Android 15)" >> google_play_deployment.txt
              echo "Features: WebView wrapper loading remote app" >> google_play_deployment.txt
              echo "Tablet Support: Yes (all screen sizes)" >> google_play_deployment.txt
              echo "SSL Security: handler.cancel() - Google Play compliant" >> google_play_deployment.txt
              echo "Status: Ready for Google Play Console Upload" >> google_play_deployment.txt
              
              echo "AAB generation completed successfully!"
              ls -la *.aab
          else
              echo "ERROR: AAB file not generated"
              echo "Checking all build outputs:"
              find OptiBuy/android -name "*.aab" -type f
              exit 1
          fi
          
    artifacts:
      - "*.aab"
      - "OptiBuy/android/app/build/outputs/bundle/release/app-release.aab"
      - "OptiBuy/optibuy-upload-certificate.pem"
      - "google_play_deployment.txt"
    publishing:
      email:
        recipients:
          - build@optibuy.com
        notify:
          success: true
          failure: true
