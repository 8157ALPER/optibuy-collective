workflows:
  optibuy:
    name: ANYQUE Android Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      groups:
        - android_signing
      vars:
        PACKAGE_NAME: "com.optibuy.collective"
        JAVA_HOME: /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
        ANDROID_HOME: /usr/local/share/android-sdk
        PATH: $PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
    scripts:
      - name: Install React Native CLI and Create Project
        script: |
          echo "=== Installing React Native CLI and Dependencies ==="
          
          # Ensure we have the latest Node.js LTS
          node --version
          npm --version
          
          # Install React Native CLI globally with force to avoid conflicts
          npm install -g @react-native-community/cli react-native --force
          
          # Verify installation
          npx react-native --version || echo "RN CLI installed, continuing..."
          
          # Create React Native project with proper error handling
          echo "Creating React Native project..."
          if npx react-native@latest init OptiBuy --template react-native-template-typescript --skip-install; then
            echo "Project created successfully"
            ls -la
          else
            echo "Init failed, creating manually..."
            # Fallback: Create project structure manually
            mkdir -p OptiBuy
            cd OptiBuy
            
            # Initialize npm project
            cat > package.json << 'EOF'
          {
            "name": "OptiBuy",
            "version": "1.0.0",
            "private": true,
            "scripts": {
              "android": "react-native run-android",
              "bundle:android": "react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/src/main/assets/index.android.bundle",
              "start": "react-native start",
              "test": "jest",
              "lint": "eslint . --ext .js,.jsx,.ts,.tsx"
            },
            "dependencies": {
              "react": "18.2.0",
              "react-native": "0.72.6"
            },
            "devDependencies": {
              "@babel/core": "^7.20.0",
              "@babel/preset-env": "^7.20.0",
              "@babel/runtime": "^7.20.0",
              "@react-native/eslint-config": "^0.72.2",
              "@react-native/metro-config": "^0.72.11",
              "@tsconfig/react-native": "^3.0.0",
              "@types/react": "^18.0.24",
              "@types/react-test-renderer": "^18.0.0",
              "babel-jest": "^29.2.1",
              "eslint": "^8.19.0",
              "jest": "^29.2.1",
              "metro-react-native-babel-preset": "0.76.8",
              "prettier": "^2.4.1",
              "react-test-renderer": "18.2.0",
              "typescript": "4.8.4"
            },
            "jest": {
              "preset": "react-native"
            }
          }
          EOF
            
            # Create basic React Native structure
            npm install react-native --save
            npx react-native init . --skip-install || echo "Manual init continuing..."
            cd ..
          fi
          
          # Verify project exists
          echo "=== Project Structure Verification ==="
          ls -la
          
          if [ -d "OptiBuy" ]; then
            echo "OptiBuy directory exists"
            cd OptiBuy
            ls -la
            
            # Install dependencies if not already done
            if [ ! -d "node_modules" ]; then
              echo "Installing dependencies..."
              npm install
            fi
            
            # Ensure Android directory exists
            if [ ! -d "android" ]; then
              echo "Creating Android structure..."
              npx react-native init tempProject --skip-install
              cp -r tempProject/android ./
              rm -rf tempProject
            fi
          else
            echo "ERROR: OptiBuy directory not created"
            exit 1
          fi
          
      - name: Configure Android Project
        script: |
          echo "=== Configuring Android for AAB Build ==="
          cd OptiBuy
          
          # Verify we're in the right place
          pwd
          ls -la
          
          # Ensure android directory exists
          if [ ! -d "android" ]; then
            echo "ERROR: android directory missing"
            exit 1
          fi
          
          # Configure gradle.properties
          echo "Configuring gradle.properties..."
          cat >> android/gradle.properties << 'EOF'
          
          # Enable AAB (Android App Bundle) generation
          android.bundle.enableUncompressedNativeLibs=false
          android.enableR8.fullMode=true
          android.useAndroidX=true
          android.enableJetifier=true
          
          # Performance improvements
          org.gradle.jvmargs=-Xmx4096m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.daemon=true
          
          # Use debug keystore for Google Play App Signing
          MYAPP_UPLOAD_STORE_FILE=debug.keystore
          MYAPP_UPLOAD_KEY_ALIAS=androiddebugkey
          MYAPP_UPLOAD_STORE_PASSWORD=android
          MYAPP_UPLOAD_KEY_PASSWORD=android
          EOF
          
          # Configure app/build.gradle for AAB
          echo "Configuring build.gradle..."
          cat > android/app/build.gradle << 'EOF'
          apply plugin: "com.android.application"
          apply plugin: "com.facebook.react"
          
          react {
              entryFile = "index.js"
              enableHermes = true
              bundleInDebug = false
              bundleInRelease = true
          }
          
          android {
              ndkVersion rootProject.ext.ndkVersion
              compileSdkVersion rootProject.ext.compileSdkVersion
              
              namespace "com.optibuy.collective"
              defaultConfig {
                  applicationId "com.optibuy.collective"
                  minSdkVersion rootProject.ext.minSdkVersion
                  targetSdkVersion rootProject.ext.targetSdkVersion
                  versionCode 1
                  versionName "1.0"
              }
              
              signingConfigs {
                  debug {
                      storeFile file('debug.keystore')
                      storePassword 'android'
                      keyAlias 'androiddebugkey'
                      keyPassword 'android'
                  }
                  release {
                      storeFile file('debug.keystore')
                      storePassword 'android'
                      keyAlias 'androiddebugkey'
                      keyPassword 'android'
                  }
              }
              
              buildTypes {
                  debug {
                      signingConfig signingConfigs.debug
                  }
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
                  }
              }
              
              bundle {
                  language {
                      enableSplit = false
                  }
                  density {
                      enableSplit = true
                  }
                  abi {
                      enableSplit = true
                  }
              }
          }
          
          dependencies {
              implementation "com.facebook.react:react-android"
              implementation "com.facebook.react:hermes-android"
              
              if (hermesEnabled.toBoolean()) {
                  implementation("com.facebook.react:hermes-android")
              } else {
                  implementation jscFlavor
              }
          }
          EOF
          
          # Create App.tsx with OptiBuy content
          cat > App.tsx << 'EOF'
          import React from 'react';
          import {
            SafeAreaView,
            ScrollView,
            StatusBar,
            StyleSheet,
            Text,
            View,
            useColorScheme,
          } from 'react-native';
          
          function App(): JSX.Element {
            const isDarkMode = useColorScheme() === 'dark';
          
            const backgroundStyle = {
              backgroundColor: isDarkMode ? '#1a1a1a' : '#f8f9fa',
              flex: 1,
            };
          
            return (
              <SafeAreaView style={backgroundStyle}>
                <StatusBar
                  barStyle={isDarkMode ? 'light-content' : 'dark-content'}
                  backgroundColor={backgroundStyle.backgroundColor}
                />
                <ScrollView
                  contentInsetAdjustmentBehavior="automatic"
                  style={backgroundStyle}>
                  <View style={styles.container}>
                    <Text style={[styles.title, {color: isDarkMode ? '#fff' : '#000'}]}>
                      OptiBuy
                    </Text>
                    <Text style={[styles.subtitle, {color: isDarkMode ? '#ccc' : '#666'}]}>
                      Collective Purchasing Platform
                    </Text>
                    
                    <View style={styles.featuresContainer}>
                      <View style={styles.feature}>
                        <Text style={styles.featureIcon}>üõçÔ∏è</Text>
                        <Text style={[styles.featureTitle, {color: isDarkMode ? '#fff' : '#000'}]}>
                          Group Buying
                        </Text>
                        <Text style={[styles.featureText, {color: isDarkMode ? '#ccc' : '#666'}]}>
                          Join others buying the same items to unlock bulk discounts
                        </Text>
                      </View>
                      
                      <View style={styles.feature}>
                        <Text style={styles.featureIcon}>üí∞</Text>
                        <Text style={[styles.featureTitle, {color: isDarkMode ? '#fff' : '#000'}]}>
                          Better Prices
                        </Text>
                        <Text style={[styles.featureText, {color: isDarkMode ? '#ccc' : '#666'}]}>
                          Access wholesale pricing through collective purchasing power
                        </Text>
                      </View>
                      
                      <View style={styles.feature}>
                        <Text style={styles.featureIcon}>ü§ù</Text>
                        <Text style={[styles.featureTitle, {color: isDarkMode ? '#fff' : '#000'}]}>
                          B2B Solutions
                        </Text>
                        <Text style={[styles.featureText, {color: isDarkMode ? '#ccc' : '#666'}]}>
                          Specialized tools for veterinary clinics and pharmacies
                        </Text>
                      </View>
                      
                      <View style={styles.feature}>
                        <Text style={styles.featureIcon}>üì±</Text>
                        <Text style={[styles.featureTitle, {color: isDarkMode ? '#fff' : '#000'}]}>
                          Mobile First
                        </Text>
                        <Text style={[styles.featureText, {color: isDarkMode ? '#ccc' : '#666'}]}>
                          Optimized for mobile commerce and quick purchasing decisions
                        </Text>
                      </View>
                    </View>
                    
                    <Text style={[styles.readyText, {color: isDarkMode ? '#4CAF50' : '#2E7D32'}]}>
                      Ready for Google Play Store deployment
                    </Text>
                  </View>
                </ScrollView>
              </SafeAreaView>
            );
          }
          
          const styles = StyleSheet.create({
            container: {
              flex: 1,
              padding: 20,
              alignItems: 'center',
            },
            title: {
              fontSize: 32,
              fontWeight: 'bold',
              marginBottom: 8,
              textAlign: 'center',
            },
            subtitle: {
              fontSize: 18,
              marginBottom: 40,
              textAlign: 'center',
            },
            featuresContainer: {
              width: '100%',
              marginBottom: 40,
            },
            feature: {
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              padding: 20,
              marginBottom: 15,
              borderRadius: 12,
              alignItems: 'center',
            },
            featureIcon: {
              fontSize: 32,
              marginBottom: 8,
            },
            featureTitle: {
              fontSize: 18,
              fontWeight: 'bold',
              marginBottom: 8,
              textAlign: 'center',
            },
            featureText: {
              fontSize: 14,
              textAlign: 'center',
              lineHeight: 20,
            },
            readyText: {
              fontSize: 16,
              fontWeight: '600',
              textAlign: 'center',
            },
          });
          
          export default App;
          EOF
          
      - name: Build React Native Bundle and AAB
        script: |
          echo "=== Building React Native Bundle ==="
          cd OptiBuy
          
          # Create assets directory
          mkdir -p android/app/src/main/assets
          
          # Generate React Native bundle
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res/ || echo "Bundle creation completed with warnings"
          
          echo "=== Building AAB ==="
          cd android
          
          # Make gradlew executable
          chmod +x gradlew
          
          # Clean and build
          ./gradlew clean
          ./gradlew bundleRelease
          
          # Verify AAB creation
          echo "=== AAB Verification ==="
          ls -la app/build/outputs/bundle/release/
          
          if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
            echo "AAB created successfully"
            
            # Validate file structure
            file app/build/outputs/bundle/release/app-release.aab
            
            # Copy to root for artifacts
            cd ../..
            cp OptiBuy/android/app/build/outputs/bundle/release/app-release.aab ./optibuy-valid.aab
            cp OptiBuy/android/app/build/outputs/bundle/release/app-release.aab ./optibuy-$(date +%Y%m%d-%H%M).aab
            
            # Final verification
            echo "=== Final Files ==="
            ls -la *.aab
            file *.aab
            
            # Create verification summary
            echo "=== AAB VERIFICATION SUMMARY ===" > aab_verification.txt
            echo "Build completed: $(date)" >> aab_verification.txt
            echo "AAB files created:" >> aab_verification.txt
            ls -la *.aab >> aab_verification.txt
            echo "File types:" >> aab_verification.txt
            file *.aab >> aab_verification.txt
            
            echo "AAB build completed successfully!"
          else
            echo "ERROR: AAB file not generated"
            echo "Build outputs:"
            find OptiBuy/android -name "*.aab" -o -name "*.apk" | head -10
            exit 1
          fi
          
    artifacts:
      - "*.aab"
      - "aab_verification.txt"
      - "OptiBuy/android/app/build/outputs/bundle/release/app-release.aab"
      - "OptiBuy/android/app/build/outputs/mapping/release/mapping.txt"
    publishing:
      email:
        recipients:
          - build@optibuy.com
        notify:
          success: true
          failure: true
